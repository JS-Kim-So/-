<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>입출고 이력</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<div class="layout">
    <aside class="sidebar">
        <div class="brand">재고 관리</div>
        <nav>
            <a href="/" data-page="dashboard">대시보드</a>
            <a href="/ui/products" data-page="products">제품 관리</a>
            <a href="/ui/lots" data-page="lots">로트 관리</a>
            <a href="/ui/inbound" data-page="inbound">입고 등록</a>
            <a href="/ui/outbound" data-page="outbound">출고 등록</a>
            <a href="/ui/transactions" data-page="transactions">입출고 이력</a>
            <a href="/docs" target="_blank">API 문서</a>
        </nav>
    </aside>
    <main class="content">
        <h1 class="page-title">입출고 이력</h1>
        <div class="card">
            <div class="form-row">
                <div>
                    <div class="label">시작 일시</div>
                    <input type="datetime-local" id="tx-start">
                </div>
                <div>
                    <div class="label">종료 일시</div>
                    <input type="datetime-local" id="tx-end">
                </div>
                <div>
                    <div class="label">제품코드</div>
                    <input type="text" id="tx-product-code" placeholder="부분 검색">
                </div>
                <div>
                    <div class="label">로트 ID</div>
                    <input type="number" id="tx-lot-id" placeholder="숫자">
                </div>
                <div class="actions">
                    <button id="tx-search">검색</button>
                    <button id="tx-refresh">새로고침</button>
                </div>
            </div>
        </div>

        <div class="card">
            <table class="table" id="tx-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>일시</th>
                        <th>유형</th>
                        <th>제품 ID</th>
                        <th>로트 ID</th>
                        <th>수량</th>
                        <th>참고전표</th>
                        <th>메모</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="tx-message"></div>
    </main>
</div>
<script>
const currentPath = window.location.pathname;
document.querySelectorAll('.sidebar a').forEach(link => {
    if (link.getAttribute('href') === currentPath) link.classList.add('active');
});

const txTableBody = document.querySelector('#tx-table tbody');
const txMessage = document.getElementById('tx-message');

function showMessage(text, type='success') {
    txMessage.innerHTML = `<div class="message ${type}">${text}</div>`;
}

async function loadTransactions() {
    const params = new URLSearchParams();
    const start = document.getElementById('tx-start').value;
    const end = document.getElementById('tx-end').value;
    const productCode = document.getElementById('tx-product-code').value.trim();
    const lotId = document.getElementById('tx-lot-id').value;
    if (start) params.append('start_datetime', new Date(start).toISOString());
    if (end) params.append('end_datetime', new Date(end).toISOString());
    if (productCode) params.append('product_code', productCode);
    if (lotId) params.append('lot_id', lotId);
    const res = await fetch(`/inventory/transactions?${params.toString()}`);
    if (!res.ok) {
        return showMessage('요청 처리 중 오류가 발생했습니다.', 'error');
    }
    const list = await res.json();
    txTableBody.innerHTML = '';
    list.forEach(tx => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${tx.tx_id}</td><td>${tx.tx_datetime}</td><td>${tx.tx_type}</td><td>${tx.product_id}</td><td>${tx.lot_id}</td><td>${tx.qty}</td><td>${tx.ref_doc || ''}</td><td>${tx.note || ''}</td>`;
        txTableBody.appendChild(tr);
    });
}

document.getElementById('tx-search').addEventListener('click', (e) => { e.preventDefault(); loadTransactions(); });
document.getElementById('tx-refresh').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('tx-start').value = '';
    document.getElementById('tx-end').value = '';
    document.getElementById('tx-product-code').value = '';
    document.getElementById('tx-lot-id').value = '';
    loadTransactions();
});

loadTransactions();
</script>
</body>
</html>
