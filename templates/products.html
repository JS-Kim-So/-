<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>제품 관리</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
<div class="layout">
    <aside class="sidebar">
        <div class="brand">재고 관리</div>
        <nav>
            <a href="/" data-page="dashboard">대시보드</a>
            <a href="/ui/products" data-page="products">제품 관리</a>
            <a href="/ui/lots" data-page="lots">로트 관리</a>
            <a href="/ui/inbound" data-page="inbound">입고 등록</a>
            <a href="/ui/outbound" data-page="outbound">출고 등록</a>
            <a href="/ui/transactions" data-page="transactions">입출고 이력</a>
            <a href="/docs" target="_blank">API 문서</a>
        </nav>
    </aside>
    <main class="content">
        <h1 class="page-title">제품 관리</h1>
        <div class="card">
            <h3>제품군 등록</h3>
            <form id="group-form" class="form-row">
                <div>
                    <div class="label">제품군명 *</div>
                    <input type="text" id="group-name" placeholder="예: 식품" required>
                </div>
                <div class="actions">
                    <button type="submit">제품군 추가</button>
                </div>
            </form>
            <div id="group-message"></div>
        </div>

        <div class="card">
            <h3>제품 등록/수정</h3>
            <form id="product-form" class="grid">
                <div class="form-row">
                    <div>
                        <div class="label">제품군 *</div>
                        <select id="product-group" required></select>
                    </div>
                    <div>
                        <div class="label">제품코드 *</div>
                        <input type="text" id="product-code" placeholder="예: P001" required>
                    </div>
                    <div>
                        <div class="label">제품명 *</div>
                        <input type="text" id="product-name" placeholder="예: 사과" required>
                    </div>
                    <div>
                        <div class="label">규격</div>
                        <input type="text" id="product-spec" placeholder="선택 입력">
                    </div>
                    <div>
                        <div class="label">사용 여부</div>
                        <select id="product-active">
                            <option value="true">사용</option>
                            <option value="false">미사용</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <div class="label">수정 대상 제품 ID (수정 시 입력)</div>
                        <input type="number" id="product-id" placeholder="수정할 제품 ID">
                    </div>
                </div>
                <div class="actions">
                    <button type="submit">저장</button>
                    <button type="button" id="product-reset">폼 초기화</button>
                </div>
            </form>
            <div id="product-message"></div>
        </div>

        <div class="card">
            <h3>제품 목록</h3>
            <div class="form-row">
                <div>
                    <div class="label">제품코드 검색</div>
                    <input type="text" id="product-search" placeholder="코드 또는 이름">
                </div>
                <div class="actions">
                    <button id="product-search-btn">검색</button>
                    <button id="product-refresh">새로고침</button>
                </div>
            </div>
            <table class="table" id="product-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>제품군</th>
                        <th>코드</th>
                        <th>이름</th>
                        <th>규격</th>
                        <th>상태</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>
</div>
<script>
const currentPath = window.location.pathname;
document.querySelectorAll('.sidebar a').forEach(link => {
    if (link.getAttribute('href') === currentPath) link.classList.add('active');
});

const groupSelect = document.getElementById('product-group');
const productTableBody = document.querySelector('#product-table tbody');
const productMessage = document.getElementById('product-message');
const groupMessage = document.getElementById('group-message');

function showMessage(target, text, type='success') {
    target.innerHTML = `<div class="message ${type}">${text}</div>`;
}

async function loadGroups() {
    groupSelect.innerHTML = '';
    const res = await fetch('/product-groups');
    const groups = await res.json();
    groups.forEach(g => {
        const option = document.createElement('option');
        option.value = g.group_id;
        option.textContent = `${g.group_name}${g.is_active ? '' : ' (미사용)'}`;
        groupSelect.appendChild(option);
    });
}

async function loadProducts(q='') {
    productTableBody.innerHTML = '';
    const url = q ? `/products?q=${encodeURIComponent(q)}` : '/products';
    const res = await fetch(url);
    const products = await res.json();
    products.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.product_id}</td>
            <td>${p.group_id}</td>
            <td>${p.product_code}</td>
            <td>${p.product_name}</td>
            <td>${p.spec || ''}</td>
            <td>${p.is_active ? '사용' : '미사용'}</td>`;
        tr.addEventListener('click', () => {
            document.getElementById('product-id').value = p.product_id;
            groupSelect.value = p.group_id;
            document.getElementById('product-code').value = p.product_code;
            document.getElementById('product-name').value = p.product_name;
            document.getElementById('product-spec').value = p.spec || '';
            document.getElementById('product-active').value = p.is_active ? 'true' : 'false';
            showMessage(productMessage, '선택한 제품 정보가 폼에 채워졌습니다.', 'success');
        });
        productTableBody.appendChild(tr);
    });
}

function validateRequired(fields) {
    for (const val of fields) {
        if (!val) return false;
    }
    return true;
}

document.getElementById('group-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('group-name').value.trim();
    if (!name) return showMessage(groupMessage, '필수 항목을 입력하세요.', 'error');
    const res = await fetch('/product-groups', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ group_name: name }) });
    if (res.ok) {
        showMessage(groupMessage, '제품군이 저장되었습니다.');
        document.getElementById('group-name').value = '';
        loadGroups();
    } else {
        showMessage(groupMessage, '요청 처리 중 오류가 발생했습니다.', 'error');
    }
});

document.getElementById('product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
        group_id: parseInt(groupSelect.value, 10),
        product_code: document.getElementById('product-code').value.trim(),
        product_name: document.getElementById('product-name').value.trim(),
        spec: document.getElementById('product-spec').value.trim() || null,
        is_active: document.getElementById('product-active').value === 'true'
    };
    if (!validateRequired([payload.group_id, payload.product_code, payload.product_name])) {
        return showMessage(productMessage, '필수 항목을 입력하세요.', 'error');
    }
    const productId = document.getElementById('product-id').value;
    const method = productId ? 'PUT' : 'POST';
    const url = productId ? `/products/${productId}` : '/products';
    const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
    if (res.ok) {
        showMessage(productMessage, productId ? '제품이 수정되었습니다.' : '제품이 등록되었습니다.');
        loadProducts();
    } else {
        showMessage(productMessage, '요청 처리 중 오류가 발생했습니다.', 'error');
    }
});

document.getElementById('product-reset').addEventListener('click', () => {
    document.getElementById('product-id').value = '';
    document.getElementById('product-code').value = '';
    document.getElementById('product-name').value = '';
    document.getElementById('product-spec').value = '';
    document.getElementById('product-active').value = 'true';
    showMessage(productMessage, '입력 폼이 초기화되었습니다.', 'success');
});

document.getElementById('product-search-btn').addEventListener('click', (e) => {
    e.preventDefault();
    const term = document.getElementById('product-search').value.trim();
    loadProducts(term);
});

document.getElementById('product-refresh').addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('product-search').value = '';
    loadProducts();
});

loadGroups();
loadProducts();
</script>
</body>
</html>
